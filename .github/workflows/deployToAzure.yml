name: Deploy ARM Template

on:
  push:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:      

env:
  RESOURCE_GROUP_NAME: SpDbTool

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check AZURE_SUBSCRIPTION_ID
        env: 
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        if: ${{ env.AZURE_SUBSCRIPTION_ID == '' }}
        uses: actions/github-script@v3
        with:
          script: |
            core.setFailed('AZURE_SUBSCRIPTION_ID must be set!')

      - name: Check AZURE_CREDENTIALS
        env: 
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_CREDENTIALS }}
        if: ${{ env.AZURE_CREDENTIALS == '' }}
        uses: actions/github-script@v3
        with:
          script: |
            core.setFailed('AZURE_CREDENTIALS must be set!')

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy ARM Template
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.RESOURCE_GROUP_NAME }}
          template: ./ArmTemplates/ResourceGroup/template.json
          parameters: ./ArmTemplates/ResourceGroup/parameters.json "rgName=${{ env.RESOURCE_GROUP_NAME }} "